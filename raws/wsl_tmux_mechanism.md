# WSL + tmux マルチエージェント機構 解説レポート

> **作成日**: 2026-01-29
> **作成者**: 足軽1号（シニアソフトウェアエンジニアとして）
> **対象システム**: multi-agent-shogun

---

## 1. 概要

multi-agent-shogunは、WSL（Windows Subsystem for Linux）とtmuxを組み合わせて、複数のClaude Codeインスタンスを並列稼働させるマルチエージェント開発基盤である。

戦国時代の軍制をモチーフとした階層構造により、複数のプロジェクトを効率的に並行管理できる。

---

## 2. 階層構造

```
上様（人間 / The Lord）
  │
  ▼ 指示
┌──────────────────────────────────────────────────┐
│                    SHOGUN                         │
│                   （将軍）                         │
│          プロジェクト全体を統括                    │
│          自ら手を動かさず、戦略を立てる            │
└───────────────────────┬──────────────────────────┘
                        │ YAMLファイル経由
                        ▼
┌──────────────────────────────────────────────────┐
│                     KARO                          │
│                   （家老）                         │
│           タスク管理・分配担当                     │
│           足軽への指示・報告集約                   │
└───────────────────────┬──────────────────────────┘
                        │ YAMLファイル経由
                        ▼
┌───┬───┬───┬───┬───┬───┬───┬───┐
│ A1│ A2│ A3│ A4│ A5│ A6│ A7│ A8│  ← 足軽（実働部隊）
│   │   │   │   │   │   │   │   │    最大8並列
└───┴───┴───┴───┴───┴───┴───┴───┘
```

### 各役割の責務

| 役割 | 責務 | 禁止事項 |
|------|------|----------|
| **将軍** | プロジェクト統括、戦略立案 | 直接タスク実行、足軽への直接指示 |
| **家老** | タスク分解、足軽管理、dashboard更新 | 直接タスク実行、人間への直接報告 |
| **足軽** | 実際の作業実行 | 将軍への直接報告、人間への直接連絡 |

---

## 3. tmuxセッション構成

### セッション構造図

```
┌─────────────────────────────────────────────────────────────┐
│                   tmux サーバー                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ セッション: shogun                                    │   │
│  │ ┌─────────────────────────────────────────────────┐ │   │
│  │ │ Pane 0: SHOGUN（将軍）                           │ │   │
│  │ │ - Claude Code インスタンス                       │ │   │
│  │ │ - プロジェクト統括                               │ │   │
│  │ └─────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ セッション: multiagent                                │   │
│  │ ┌─────────────┬─────────────┬─────────────┬───────┐ │   │
│  │ │ Pane 0     │ Pane 1     │ Pane 2     │ ...   │ │   │
│  │ │ KARO       │ ashigaru1  │ ashigaru2  │       │ │   │
│  │ │（家老）     │（足軽1）    │（足軽2）    │ 3-8   │ │   │
│  │ └─────────────┴─────────────┴─────────────┴───────┘ │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### ペイン識別子

| エージェント | tmuxペイン識別子 |
|-------------|------------------|
| 将軍 | `shogun` (セッション) |
| 家老 | `multiagent:0.0` |
| 足軽1 | `multiagent:0.1` |
| 足軽2 | `multiagent:0.2` |
| ... | ... |
| 足軽8 | `multiagent:0.8` |

---

## 4. send-keys によるエージェント間通信

### 基本原理

tmuxの `send-keys` コマンドを使用して、あるペインから別のペインにテキストを送信する。
これにより、待機中のClaude Codeインスタンスに入力を与え、「起動」させる。

### 通信フロー

```
┌─────────┐     send-keys      ┌─────────┐
│  将軍   │ ─────────────────> │  家老   │
│         │  "YAMLを確認せよ"   │         │
└─────────┘                    └─────────┘
                                    │
                                    │ send-keys
                                    │ "任務がある"
                                    ▼
                               ┌─────────┐
                               │ 足軽N  │
                               └─────────┘
```

### 🔴 重要：send-keys は2回に分けて実行

Claude Codeの仕様上、send-keysは**必ず2回に分けて**実行する必要がある。

#### ❌ 禁止パターン

```bash
# 1回でメッセージとEnterを送る（動作しない）
tmux send-keys -t multiagent:0.0 'メッセージ' Enter
```

#### ✅ 正しい方法

```bash
# 【1回目】メッセージを送信
tmux send-keys -t multiagent:0.0 'queue/tasks/ashigaru1.yaml に任務がある。確認して実行せよ。'

# 【2回目】Enterを送信（別のBash呼び出しで）
tmux send-keys -t multiagent:0.0 Enter
```

### 通信方向のルール

| 方向 | 許可 | 方法 |
|------|------|------|
| 将軍 → 家老 | ✅ | send-keys |
| 家老 → 足軽 | ✅ | send-keys |
| 足軽 → 家老 | ✅ | send-keys |
| 家老 → 将軍 | ❌ | dashboard.md更新で報告 |
| 足軽 → 将軍 | ❌ | 家老経由 |

**理由**: 上への send-keys を禁止することで、人間（殿）の入力中に割り込みが発生するのを防ぐ。

---

## 5. YAMLファイルによる指示・報告の流れ

### ファイル構成

```
multi-agent-shogun/
├── queue/
│   ├── shogun_to_karo.yaml       # 将軍 → 家老 指示
│   ├── karo_to_ashigaru.yaml     # （レガシー、現在は各足軽専用ファイルを使用）
│   ├── tasks/
│   │   ├── ashigaru1.yaml        # 足軽1専用タスク
│   │   ├── ashigaru2.yaml        # 足軽2専用タスク
│   │   ├── ...
│   │   └── ashigaru8.yaml        # 足軽8専用タスク
│   └── reports/
│       ├── ashigaru1_report.yaml # 足軽1報告
│       ├── ashigaru2_report.yaml # 足軽2報告
│       ├── ...
│       └── ashigaru8_report.yaml # 足軽8報告
├── config/
│   ├── projects.yaml             # プロジェクト一覧
│   └── settings.yaml             # システム設定
├── status/
│   └── master_status.yaml        # 全体進捗
└── dashboard.md                  # 人間用ダッシュボード
```

### 指示の流れ（上→下）

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 人間が将軍に指示                                          │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. 将軍: queue/shogun_to_karo.yaml にコマンド記載            │
│                                                             │
│    queue:                                                   │
│      - id: cmd_001                                          │
│        timestamp: "2026-01-29T19:00:00"                     │
│        command: "WBSを更新せよ"                              │
│        project: ts_project                                  │
│        priority: high                                       │
│        status: pending                                      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. 将軍: send-keys で家老を起動                              │
│    tmux send-keys -t multiagent:0.0 '新しい指示がある...'    │
│    tmux send-keys -t multiagent:0.0 Enter                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. 家老: YAML読み込み → タスク分解                           │
│    → queue/tasks/ashigaru{N}.yaml に各足軽用タスク記載       │
│                                                             │
│    task:                                                    │
│      task_id: subtask_001                                   │
│      parent_cmd: cmd_001                                    │
│      description: "具体的な作業内容"                         │
│      target_path: "/path/to/output"                         │
│      status: assigned                                       │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 5. 家老: send-keys で足軽を起動                              │
│    tmux send-keys -t multiagent:0.{N} '任務がある...'        │
│    tmux send-keys -t multiagent:0.{N} Enter                 │
└─────────────────────────────────────────────────────────────┘
```

### 報告の流れ（下→上）

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 足軽: 作業完了                                            │
│    → queue/reports/ashigaru{N}_report.yaml に報告記載        │
│                                                             │
│    worker_id: ashigaru1                                     │
│    task_id: subtask_001                                     │
│    timestamp: "2026-01-29T19:15:00"                         │
│    status: done                                             │
│    result:                                                  │
│      summary: "作業完了"                                     │
│      files_modified: [...]                                  │
│    skill_candidate:                                         │
│      found: false                                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. 足軽: send-keys で家老に通知                              │
│    tmux send-keys -t multiagent:0.0 '任務完了でござる...'    │
│    tmux send-keys -t multiagent:0.0 Enter                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. 家老: 報告ファイルをスキャン                              │
│    → dashboard.md を更新（将軍への send-keys は行わない）     │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. 将軍/人間: dashboard.md を確認して状況把握                │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. イベント駆動設計（ポーリング禁止）

### なぜポーリング禁止か

- **API代金の無駄**: 待機ループは無駄なAPI呼び出しを発生させる
- **リソース消費**: 無駄な処理が発生

### イベント駆動の仕組み

```
┌────────────────────────────────────────────────────────────────┐
│                       イベント駆動モデル                        │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│   ┌─────────┐                        ┌─────────┐              │
│   │ Agent A │  ----[停止中]----->    │ Agent B │              │
│   │(送信側) │                        │(受信側) │              │
│   └────┬────┘                        └────┬────┘              │
│        │                                  │                   │
│        │ 1. YAMLに指示を書く               │ (プロンプト待ち)   │
│        │                                  │                   │
│        │ 2. send-keys で起動              │                   │
│        │ ─────────────────────────────────>                   │
│        │                                  │                   │
│        │ 3. 自分は処理終了                 │ 4. 起動           │
│        │    (プロンプト待ち)               │    YAMLを読む     │
│        │                                  │    作業実行       │
│        │                                  │                   │
│        │         <─────────────────────────                   │
│        │         5. 完了時に send-keys     │                   │
│        │            (下→上以外)            │                   │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 「起こされたら全確認」方式

Claude Codeは「待機」できない。プロンプト待ちは「停止」と同義。

1. エージェントが起動される
2. 関連する全ファイルをスキャン
3. 必要な処理を実行
4. 処理終了（プロンプト待ちに戻る）

---

## 7. 同一ファイル書き込み禁止（RACE-001）

### 問題

複数の足軽が同じファイルに書き込むと、競合が発生する可能性がある。

### 解決策

各足軽に**専用ファイル**を割り当てる。

```
❌ 禁止パターン:
  足軽1 → output.md
  足軽2 → output.md  ← 競合リスク

✅ 正しいパターン:
  足軽1 → queue/tasks/ashigaru1.yaml （専用）
  足軽2 → queue/tasks/ashigaru2.yaml （専用）
```

---

## 8. dashboard.md の役割

### 概要

`dashboard.md` は人間用のリアルタイム状況表示ボード。

### 更新責任者

**家老のみ**が更新する（将軍・足軽は更新しない）。

### 構成

```markdown
# 📊 戦況報告
最終更新: 2026-01-29 19:00

## 🚨 要対応 - 殿のご判断をお待ちしております
（人間の判断が必要な事項）

## 🔄 進行中 - 只今、戦闘中でござる
（現在実行中のタスク）

## ✅ 本日の戦果
（完了したタスク）

## 🎯 スキル化候補 - 承認待ち
（再利用可能なパターンの提案）
```

---

## 9. 技術的な仕組みまとめ

```
┌──────────────────────────────────────────────────────────────────┐
│                    multi-agent-shogun 技術スタック               │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │      WSL2       │  │      tmux       │  │   Claude Code   │ │
│  │                 │  │                 │  │                 │ │
│  │ Linux環境を    │  │ ターミナル多重化 │  │ AIコーディング  │ │
│  │ Windows上で実行 │  │ セッション管理  │  │ アシスタント    │ │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘ │
│           │                    │                    │          │
│           └────────────────────┼────────────────────┘          │
│                                │                               │
│                    ┌───────────▼───────────┐                   │
│                    │      YAML Files        │                   │
│                    │                        │                   │
│                    │  ・指示の構造化        │                   │
│                    │  ・報告の標準化        │                   │
│                    │  ・状態管理            │                   │
│                    └────────────────────────┘                   │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    通信メカニズム                          │ │
│  │                                                           │ │
│  │  send-keys: エージェント間の起動トリガー                  │ │
│  │  YAML: 指示・報告の内容                                   │ │
│  │  dashboard.md: 人間への状況報告                           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 10. 利点と制約

### 利点

| 項目 | 説明 |
|------|------|
| **並列処理** | 最大8つの足軽が同時に作業可能 |
| **階層管理** | 明確な指揮系統で混乱を防止 |
| **API節約** | イベント駆動でポーリング不要 |
| **追跡可能** | YAML/ダッシュボードで状況把握 |
| **競合防止** | 専用ファイルで書き込み競合を回避 |

### 制約

| 項目 | 説明 |
|------|------|
| **WSL必須** | Windows環境ではWSL2が必要 |
| **tmux依存** | tmuxのセッション管理に依存 |
| **手動起動** | 各セッション/ペインの初期起動は手動 |
| **単方向制限** | 下→上への send-keys は禁止 |

---

## 11. 参考：tmuxコマンド集

### セッション管理

```bash
# 新規セッション作成
tmux new-session -s shogun
tmux new-session -s multiagent

# セッション一覧
tmux list-sessions

# セッションへアタッチ
tmux attach -t shogun
```

### ペイン管理

```bash
# ペイン分割（水平）
tmux split-window -h

# ペイン分割（垂直）
tmux split-window -v

# ペイン一覧
tmux list-panes -t multiagent
```

### send-keys

```bash
# メッセージ送信
tmux send-keys -t multiagent:0.1 'メッセージ'

# Enter送信
tmux send-keys -t multiagent:0.1 Enter

# ペインの内容確認
tmux capture-pane -t multiagent:0.0 -p | tail -20
```

---

**以上**
